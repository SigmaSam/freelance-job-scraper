require_relative 'spec_helper.rb'
require_relative '../lib/scraper.rb'

require 'nokogiri'

RSpec.describe Scraper do
  # rubocop:disable Layout/LineLength
  let(:raw_html_freelancer) { '<span id="total-results">21</span><div class="JobSearchCard-item "><div class="JobSearchCard-item-inner" data-project-card="true"><div class="JobSearchCard-primary"><div class="JobSearchCard-primary-heading"> <a href="/projects/php/develop-website-24431323/" class="JobSearchCard-primary-heading-link" data-qtsb-section="page-job-search-new" data-qtsb-subsection="card-job" data-qtsb-label="link-project-title" data-heading-link="true"> Develop My Website </a></div><p class="JobSearchCard-primary-description"> This is an online Social Blogging forum! built on <b>PHP</b> [login to view URL]! [login to view URL]Please check the Website throughly and then Quote!You may have to complete the front end and built an admin panel as well!You may have to design and develop in ci! so knowledge in CI , web designing and Photoshop is prerequisite!</p><div class="JobSearchCard-primary-tags" data-qtsb-section="page-job-search-new" data-qtsb-subsection="card-job" data-qtsb-label="link-skill"> <a class="JobSearchCard-primary-tagsLink" href="/jobs/codeigniter/">Codeigniter</a> <a class="JobSearchCard-primary-tagsLink" href="/jobs/graphic-design/">Graphic Design</a> <a class="JobSearchCard-primary-tagsLink" href="/jobs/html/">HTML</a> <a class="JobSearchCard-primary-tagsLink" href="/jobs/php/">PHP</a> <a class="JobSearchCard-primary-tagsLink" href="/jobs/website-design/">Website Design</a></div></div><div class="JobSearchCard-secondary"><div class="JobSearchCard-secondary-price"> $117</div></div></div></div>' }

  let(:raw_html_guru) { '<h2 class="secondaryHeading"><input type="checkbox" id="recordBulkCheckbox" class="g-chkradio g-chkradio--checkbox"> <label for="recordBulkCheckbox">7 Results</label></h2><ul class="module_list cozy" style="display: block;"><li><div class="record jobRecord"><div class="record__check"><input id="checkbox__1641708" type="checkbox" aria-label="`Select ${data.Title}`" class="g-chkradio g-chkradio--checkbox" value="1641708"> <label for="checkbox__1641708"></label></div><div class="record__details"><div class="record__header"><div class="record__header__identity"><div class="jobRecord__meta"> Posted <strong>on Mar 20, 2020</strong> ·<strong>47</strong> Quotes Received</div><h2 class="jobRecord__title jobRecord__title--changeVisited"><a href="/jobs/web-app-upgrade/1641708">Web app upgrade</a> <span><span class="module_badge badge--uppercase badge_green" style="margin-right: 6px; margin-bottom: 5px;"><span>Featured</span></span></span></h2><div class="jobRecord__budget"><span> Hourly<span><span aria-hidden="true" role="presentation" class="pipe"> | </span>$25 - $50 </span> <span title="1-3 months"><span aria-hidden="true" role="presentation" class="pipe">|</span>1-10 hrs/wk<span aria-hidden="true" role="presentation" class="pipe">|</span>1-3 months </span></span></div></div><div class="record__header__action record__header__action--full"><div class="jobDetails__recordActions"><p class="copy small grey rhythmMargin1" style="margin-right: 6px;">&nbsp; <span> Send before: <strong>April 19, 2020</strong></span></p><div class="g-recordActions--desktop"><button type="button" title="Add to Watchlist" class="module_btn outline_btn outline_btn--secondary"><i aria-hidden="true" data-icon=""></i> </button> <button type="button" title="Send a Quote" class="module_btn primary_btn"> Send a Quote </button></div><p class="copy small grey rhythmMargin1" style="margin-top: 5px; margin-right: 10px;"></p></div></div><div class="record__header__action record__header__action--mobile"><a title="View Job" aria-label="View Job" class="module_btn lonely_btn outline_btn outline_btn--secondary medium_btn"><i aria-hidden="true" data-icon=""></i></a></div></div><div class="record__content record__content--noDivider"><div class="jobRecord__body"><p class="jobRecord__desc"> Looking fir a full stack developer who has Postgres SQL and Ruby on Rails experience.You will be taking a paper report and adding it to a already developed web based ticketing software using Postgres <span> … </span></p><div class="skillsList"><span class="skillsList__skill"><i data-icon="" aria-hidden="true"></i> <a href="/d/jobs/c/programming-development" class="darkGrey"><strong>Programming &amp; Development</strong></a> <svg width="14px" height="14px" viewBox="0 0 24 24" style="vertical-align: middle; top: -2px; position: relative;"><path d="M8.59 16.34l4.58-4.59-4.58-4.59L10 5.75l6 6-6 6z"></path></svg> <a href="/d/jobs/c/programming-development/sc/apps-mobile" class="darkGrey"> Apps &amp; Mobile </a></span> <a href="/d/jobs/c/programming-development/skill/sql/" class="skillsList__skill skillsList__skill--hasHover"> SQL </a><a href="/d/jobs/c/programming-development/skill/ruby-on-rails/" class="skillsList__skill skillsList__skill--hasHover"> Ruby On Rails </a><a href="/d/jobs/c/programming-development/skill/software-development/" class="skillsList__skill skillsList__skill--hasHover"> Software Development </a><a href="/d/jobs/c/programming-development/skill/ticketing-software/" class="skillsList__skill skillsList__skill--hasHover"> Ticketing Software </a><a href="/d/jobs/c/programming-development/skill/web-development/" class="skillsList__skill skillsList__skill--hasHover"> Web Development </a><a href="/d/jobs/c/programming-development/skill/app-development/" class="skillsList__skill skillsList__skill--hasHover"> App Development </a><a href="/d/jobs/c/programming-development/skill/full-stack/" class="skillsList__skill skillsList__skill--hasHover"> Full Stack </a><a href="/d/jobs/c/programming-development/skill/magic-programming/" class="skillsList__skill skillsList__skill--hasHover"> Magic Programming </a><a href="/d/jobs/c/programming-development/skill/app-mobile-marketing/" class="skillsList__skill skillsList__skill--hasHover"> App &amp; Mobile Marketing </a><a href="/d/jobs/c/programming-development/skill/app-mobile-programming-languages/" class="skillsList__skill skillsList__skill--hasHover"> App &amp; Mobile Programming Languages </a><a href="/d/jobs/c/programming-development/skill/general-other-apps-mobile/" class="skillsList__skill skillsList__skill--hasHover"> General / Other Apps &amp; Mobile </a><a href="/d/jobs/c/programming-development/skill/mobile-device-platforms/" class="skillsList__skill skillsList__skill--hasHover"> Mobile Device Platforms </a></div></div><div class="module_avatar avatar_table thirtytwo "><div class="avatar"><img src="https://pimg-guru.com/ScreenIcon/default-user.png" alt="undefined O" title="undefined O"></div><div class="avatarinfo"><h3 class="identityName"><a role="button"><strong>Jaime O</strong></a></h3><p class="subtext darkGrey"><strong> United States </strong> <span aria-hidden="true" role="presentation" class="pipeDivider">|</span>$0 Spent</p></div></div></div></div></div></li><li><div class="record jobRecord"><div class="record__check"><input id="checkbox__1638576" type="checkbox" aria-label="`Select ${data.Title}`" class="g-chkradio g-chkradio--checkbox" value="1638576"> <label for="checkbox__1638576"></label></div><div class="record__details"><div class="record__header"><div class="record__header__identity"><div class="jobRecord__meta"> Posted <strong>on Mar 09, 2020</strong> ·<strong>35</strong> Quotes Received</div><h2 class="jobRecord__title jobRecord__title--changeVisited"><a href="/jobs/ruby-on-rails-blog-site-development/1638576">Ruby on Rails blog site development</a> <span></span></h2><div class="jobRecord__budget"><span> Fixed Price<span><span aria-hidden="true" role="presentation" class="pipe"> | </span>$500-$1k </span> </span></div></div><div class="record__header__action record__header__action--full"><div class="jobDetails__recordActions"><p class="copy small grey rhythmMargin1" style="margin-right: 6px;">&nbsp; <span> Send before: <strong>April 08, 2020</strong></span></p><div class="g-recordActions--desktop"><button type="button" title="Add to Watchlist" class="module_btn outline_btn outline_btn--secondary"><i aria-hidden="true" data-icon=""></i> </button> <button type="button" title="Send a Quote" class="module_btn primary_btn"> Send a Quote </button></div><p class="copy small grey rhythmMargin1" style="margin-top: 5px; margin-right: 10px;"></p></div></div><div class="record__header__action record__header__action--mobile"><a title="View Job" aria-label="View Job" class="module_btn lonely_btn outline_btn outline_btn--secondary medium_btn"><i aria-hidden="true" data-icon=""></i></a></div></div><div class="record__content record__content--noDivider"><div class="jobRecord__body"><p class="jobRecord__desc"> I want talented RoR full stack developer who can help me.</p><div class="skillsList"><span class="skillsList__skill"><i data-icon="" aria-hidden="true"></i> <a href="/d/jobs/c/programming-development" class="darkGrey"><strong>Programming &amp; Development</strong></a> <svg width="14px" height="14px" viewBox="0 0 24 24" style="vertical-align: middle; top: -2px; position: relative;"><path d="M8.59 16.34l4.58-4.59-4.58-4.59L10 5.75l6 6-6 6z"></path></svg> <a href="/d/jobs/c/programming-development/sc/web-development-design" class="darkGrey"> Web Development &amp; Design </a></span></div></div><div class="module_avatar avatar_table thirtytwo "><div class="avatar"><img src="https://pimg-guru.com/ScreenIcon/default-user.png" alt="undefined C" title="undefined C"></div><div class="avatarinfo"><h3 class="identityName"><a role="button"><strong>Liu C</strong></a></h3><p class="subtext darkGrey"><strong> United States </strong> <span aria-hidden="true" role="presentation" class="pipeDivider">|</span>$0 Spent</p></div></div></div></div></div></li><li><div class="record jobRecord"><div class="record__check"><input id="checkbox__1637480" type="checkbox" aria-label="`Select ${data.Title}`" class="g-chkradio g-chkradio--checkbox" value="1637480"> <label for="checkbox__1637480"></label></div><div class="record__details"><div class="record__header"><div class="record__header__identity"><div class="jobRecord__meta"> Posted <strong>on Mar 05, 2020</strong> ·<strong>37</strong> Quotes Received</div><h2 class="jobRecord__title jobRecord__title--changeVisited"><a href="/jobs/ruby-on-rails-development/1637480">Ruby on rails development</a> <span></span></h2><div class="jobRecord__budget"><span> Fixed Price<span><span aria-hidden="true" role="presentation" class="pipe"> | </span>$250-$500 </span> </span></div></div><div class="record__header__action record__header__action--full"><div class="jobDetails__recordActions"><p class="copy small grey rhythmMargin1" style="margin-right: 6px;">&nbsp; <span> Send before: <strong>April 04, 2020</strong></span></p><div class="g-recordActions--desktop"><button type="button" title="Add to Watchlist" class="module_btn outline_btn outline_btn--secondary"><i aria-hidden="true" data-icon=""></i> </button> <button type="button" title="Send a Quote" class="module_btn primary_btn"> Send a Quote </button></div><p class="copy small grey rhythmMargin1" style="margin-top: 5px; margin-right: 10px;"></p></div></div><div class="record__header__action record__header__action--mobile"><a title="View Job" aria-label="View Job" class="module_btn lonely_btn outline_btn outline_btn--secondary medium_btn"><i aria-hidden="true" data-icon=""></i></a></div></div><div class="record__content record__content--noDivider"><div class="jobRecord__body"><p class="jobRecord__desc"> I need an experienced Ruby developer to add enhancements to my Ruby application. Developer with saas application preferred</p><div class="skillsList"><span class="skillsList__skill"><i data-icon="" aria-hidden="true"></i> <a href="/d/jobs/c/programming-development" class="darkGrey"><strong>Programming &amp; Development</strong></a> <svg width="14px" height="14px" viewBox="0 0 24 24" style="vertical-align: middle; top: -2px; position: relative;"><path d="M8.59 16.34l4.58-4.59-4.58-4.59L10 5.75l6 6-6 6z"></path></svg> <a href="/d/jobs/c/programming-development/sc/web-development-design" class="darkGrey"> Web Development &amp; Design </a></span> <a href="/d/jobs/c/programming-development/skill/ruby-on-rails/" class="skillsList__skill skillsList__skill--hasHover"> Ruby On Rails </a><a href="/d/jobs/c/programming-development/skill/back-end-development/" class="skillsList__skill skillsList__skill--hasHover"> Back End Development </a></div></div><div class="module_avatar avatar_table thirtytwo "><div class="avatar"><img src="/images/default-user.png" alt="undefined j" title="undefined j"></div><div class="avatarinfo"><h3 class="identityName"><a role="button"><strong>James j</strong></a> <i data-icon="" aria-hidden="true" title="Verified Payment Method" class="greenIcon"></i></h3><p class="subtext darkGrey"><strong> United States </strong> <span aria-hidden="true" role="presentation" class="pipeDivider">|</span>$83 Spent<span aria-hidden="true" role="presentation" class="pipeDivider">|</span> <a class="module_badge feedback-score feedback-score_medium"><i data-icon="" aria-hidden="true"></i> 100% </a></p></div></div></div></div></div></li></ul>' }

  let(:raw_html_peopleperhour) { '<span id="job-listing-count" class="heading--inline results-count"> <span>2 found</span> </span><div class="job-items"><div id="job-listing-listview" class="list-view"><div class="items clearfix items-results "><div class="clearfix listing-row project-list-item job-list-item "><div class="col-xs-7 col-sm-9 col-md-10 info no-padding-left no-padding-right"><h6 class="title"> <a title="Ruby (R-O-R) Developer Needed " class="job js-paragraph-crop" data-height="65" href="https://www.peopleperhour.com/freelance-jobs/software-development/integration-api/ruby-r-o-r-developer-needed-2762436">Ruby (R-O-R) Developer Needed </a> <span class="job-etiquettes"> <span class="js-tooltip etiquette yellow" title="Based on historical data, we predict this project and any follow-on projects will generate a high value income. Our predictive model is not 100% accurate, so we cannot guarantee repeat work.">Opportunity</span> </span></h6><ul class="clearfix member-info horizontal crop hidden-xs"><li class="hidden-xs"> <i class="fpph fpph-clock-wall"></i> <span class="hidden-xs">Posted</span> <time class="crop value" datetime="2020-03-19 14:28:50" title="19 March 2020"> 5 days ago </time></li><li class="hidden-xs job-location js-tooltip" title="" data-original-title="The project can be done remotely from any location"> <i class="fpph fpph-location"></i> <span class="">Remote</span></li><li class="hidden-xs"> <i class="fa fa-dot-circle-o"></i> Proposals<span class="value proposal-count">17</span></li><li class="hidden-xs"> <a data-has-tooltip="1" rel="nofollow" data-label-add-to-fav="Add to Favourite Jobs" data-label-remove-from-fav="Remove from Favourite Jobs" class="action-entity-star fa fa-heart js-tooltip widget-star-item js-tooltip" data-title="Add to Favourite Jobs" data-url="/job/star?id=2762436" id="Star-0625a74f6b7c23dcb237f484abd544bf" data-isguest="1" data-type="Job" href="#"></a> <span class="value count-stars">5</span></li></ul></div><div class="col-xs-5 col-sm-3 col-md-2 details no-padding-right"><div class="price-tag"> $<span title="">400</span> <small class="clearfix"> Fixed Price </small></div><div class="actions"> <a class="job btn send-proposal pull-right" href="https://www.peopleperhour.com/freelance-jobs/software-development/integration-api/ruby-r-o-r-developer-needed-2762436#send-proposal">Send Proposal</a></div></div></div><div class="clearfix listing-row project-list-item job-list-item "><div class="col-xs-7 col-sm-9 col-md-10 info no-padding-left no-padding-right"><h6 class="title"> <a title="Hiring Full Stack, Front End and Back End Developers For Software Testing" class="job js-paragraph-crop" data-height="65" href="https://www.peopleperhour.com/freelance-jobs/software-development/software-testing/hiring-full-stack-front-end-and-back-end-developers-for-sof-2740988">Hiring Full Stack, Front End and Back End Developers For Software Testing</a></h6><ul class="clearfix member-info horizontal crop hidden-xs"><li class="hidden-xs"> <i class="fpph fpph-clock-wall"></i> <span class="hidden-xs">Posted</span> <time class="crop value" datetime="2020-03-02 02:52:17" title="2 March 2020"> 3 weeks ago </time></li><li class="hidden-xs job-location js-tooltip" title="" data-original-title="The project can be done remotely from any location"> <i class="fpph fpph-location"></i> <span class="">Remote</span></li><li class="hidden-xs"> <i class="fa fa-dot-circle-o"></i> Proposals<span class="value proposal-count">14</span></li><li class="hidden-xs"> <a data-has-tooltip="1" rel="nofollow" data-label-add-to-fav="Add to Favourite Jobs" data-label-remove-from-fav="Remove from Favourite Jobs" class="action-entity-star fa fa-heart js-tooltip widget-star-item js-tooltip" data-title="Add to Favourite Jobs" data-url="/job/star?id=2740988" id="Star-209f245e2ab301aea0199999e0547d57" data-isguest="1" data-type="Job" href="#"></a> <span class="value count-stars">5</span></li></ul></div><div class="col-xs-5 col-sm-3 col-md-2 details no-padding-right"><div class="price-tag"> $<span title="">350</span> <small class="clearfix"> Fixed Price </small></div><div class="actions"> <a class="job btn send-proposal pull-right" href="https://www.peopleperhour.com/freelance-jobs/software-development/software-testing/hiring-full-stack-front-end-and-back-end-developers-for-sof-2740988#send-proposal">Send Proposal</a></div></div></div></div><div class="keys" style="display:none" title="/freelance-ruby-jobs?data%5Bkeyword%5D=ruby&amp;data%5BstateUrl%5D=%2Ffreelance-ruby-jobs"><span>2762436</span><span>2740988</span></div></div></div>' }
  # rubocop:enable Layout/LineLength

  let(:parsed_html_freelancer) { Nokogiri::HTML(raw_html_freelancer) }

  let(:parsed_html_guru) { Nokogiri::HTML(raw_html_guru) }
  
  let(:parsed_html_peopleperhour) { Nokogiri::HTML(raw_html_peopleperhour) }

  let(:scraper) { Scraper.new(%w[any keyword], 'any_site') }

  describe '.scrape_freelancer' do
    it 'returns an array' do
      expect(scraper.send(:scrape_freelancer, parsed_html_freelancer).class).to eql(Array)
    end

    it 'returns an array of hashes' do
      expect(scraper.send(:scrape_freelancer, parsed_html_freelancer)[0].class).to eql(Hash)
    end
  end

  describe '.scrape_guru' do
    it 'returns an array' do
      expect(scraper.send(:scrape_guru, parsed_html_guru).class).to eql(Array)
    end

    it 'returns an array of hashes' do
      expect(scraper.send(:scrape_guru, parsed_html_guru)[0].class).to eql(Hash)
    end  
  end

  describe '.scrape_peopleperhour' do
    it 'returns an array' do
      expect(scraper.send(:scrape_peopleperhour, parsed_html_peopleperhour).class).to eql(Array)
    end

    it 'returns an array of hashes' do
      expect(scraper.send(:scrape_peopleperhour, parsed_html_peopleperhour)[0].class).to eql(Hash)
    end    
  end

  describe '.parse_keywords' do
    let(:scraper) { Scraper.new(['react js', 'ruby on rails'], 'peopleperhour') }
    let(:guru) { Scraper.new(%w[php ajax html], 'guru') }

    it 'returns string of parsed keywords for freelancer.com or peopleperhour.com' do
      expect(scraper.send(:parse_keywords)).to eql('react-js%20ruby-on-rails')
    end

    it 'returns string of parsed keywords for guru.com' do
      expect(guru.send(:parse_keywords)).to eql('php/skill/ajax/skill/html')
    end
  end

  describe '.make_url' do
    let(:freelancer) { Scraper.new(%w[any keywords], 'freelancer') }
    let(:peopleperhour) { Scraper.new(['react js', 'ruby on rails'], 'peopleperhour') }
    let(:guru) { Scraper.new(%w[php ajax html], 'guru') }

    it 'return freelancer.com search url after taking site and page as param' do
      expect(freelancer.send(:make_url, 'freelancer', 4)).to eql('https://www.freelancer.com/jobs/4/?keyword=any%20keywords')
    end

    it 'return guru.com search url after taking site and page as param' do
      expect(guru.send(:make_url, 'guru', 5)).to eql('https://www.guru.com/d/jobs/skill/php/skill/ajax/skill/html/pg/5')
    end

    it 'return peopleperhour.com search url after taking site and page as param' do
      expect(peopleperhour.send(:make_url, 'peopleperhour', 2)).to eql('https://www.peopleperhour.com/freelance-react-js%20ruby-on-rails-jobs?page=2')
    end
  end

  describe '.last_page' do
    it 'return last page of freelancer.com when freelancer and parsed html is given as param' do
      expect(scraper.send(:last_page, 'freelancer', parsed_html_freelancer)).to eql(21)
    end

    it 'return last page of guru.com when guru and parsed html is given as param' do
      expect(scraper.send(:last_page, 'guru', parsed_html_guru)).to eql(3)
    end

    it 'return last page of peopleperhour.com when peopleperhour and parsed html is given as param' do
      expect(scraper.send(:last_page, 'peopleperhour', parsed_html_peopleperhour)).to eql(1)
    end
  end
end
